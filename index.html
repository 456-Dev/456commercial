<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THEY SAID YOU CAN'T</title>
    
    <!-- Standard favicons for different sizes -->
    <link rel="icon" href="https://github.com/456-Dev/456commercial/blob/main/favicon16x16.png?raw=true" type="image/png" sizes="16x16">
    <link rel="icon" href="https://github.com/456-Dev/456commercial/blob/main/favicon32x32.png?raw=true" type="image/png" sizes="32x32">
    
    <!-- Apple Touch Icon for iOS/Safari -->
    <link rel="apple-touch-icon" href="https://github.com/456-Dev/456commercial/blob/main/favicon160x160.png?raw=true">
    <link rel="apple-touch-icon-precomposed" href="https://github.com/456-Dev/456commercial/blob/main/favicon160x160.png?raw=true">
    
    <!-- Safari specific -->
    <link rel="mask-icon" href="https://github.com/456-Dev/456commercial/blob/main/favicon32x32.png?raw=true" color="#000000">
    
    <!-- For Safari tab icon specifically -->
    <link rel="shortcut icon" href="https://github.com/456-Dev/456commercial/blob/main/favicon32x32.png?raw=true" type="image/png">
    
    <!-- iOS/Safari specific meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="THEY SAID YOU CAN'T">
    
    <!-- Main stylesheet -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="banner-wrapper">
        <header class="site-banner">
            <img src="https://github.com/456-Dev/456commercial/blob/main/websiteBANNER.png?raw=true" alt="Book Cover Image: THEY SAID YOU CAN'T" class="banner-image">
        </header>
    </div>

    <div class="main-content-wrapper">
        <!-- Author Line -->
        <div class="author-tagline-container">
            <p class="author-tagline"><em>the new photography book by <b>bignosemichael</b></em></p>
        </div>
        
        <!-- Editions Section -->
        <section id="editions" class="editions-selection-section">
            <div class="editions-grid">
                <!-- Digital Edition -->
                <article class="edition-card digital">
                    <h3 class="edition-name">Digital<br>Edition</h3>
                    <p class="edition-price">$5</p>
                    
                    <!-- Normal View Buttons -->
                    <div class="normal-view">
                        <div class="edition-buttons">
                            <button class="btn info-btn">More Info</button>
                            <a href="#digital-purchase-form" class="btn action-btn buy-digital-btn">Buy Digital</a>
                        </div>
                    </div>
                    
                    <!-- Expanded View Content -->
                    <div class="expanded-view">
                        <div class="expanded-header">
                            <h4>DIGITAL EDITION <em>[Five Dollars]</em></h4>
                            <button class="close-info-btn">×</button>
                        </div>
                        <div class="expanded-info-container">
                            <ul class="edition-info-list">
                                <li>Just a pdf of the deluxe edition
                                    <ul>
                                        <li>Delivered instantly by email</li>
                                        <li>Read on any device</li>
                                    </ul>
                                </li>
                                <li>PRINT THE BOOK YOURSELF!
                                    <ul>
                                        <li>High-resolution for printing</li>
                                        <li>Print at home or use a service</li>
                                    </ul>
                                </li>
                                <li>Free with any physical copy
                                    <ul>
                                        <li>No need to purchase separately</li>
                                        <li>Digital backup of your physical book</li>
                                    </ul>
                                </li>
                            </ul>
                            <img src="https://via.placeholder.com/80x100" alt="Digital Edition" class="edition-image">
                        </div>
                        <a href="#digital-purchase-form" class="btn action-btn buy-digital-btn">Buy Digital</a>
                    </div>
                </article>

                <!-- Standard Edition -->
                <article class="edition-card standard">
                    <h3 class="edition-name">Standard<br>Edition</h3>
                    <p class="edition-price">$20</p>
                    
                    <!-- Normal View Buttons -->
                    <div class="normal-view">
                        <div class="edition-buttons">
                            <button class="btn info-btn">More Info</button>
                            <a href="#events" class="btn action-btn reserve-physical-btn">Reserve Pickup</a>
                        </div>
                    </div>
                    
                    <!-- Expanded View Content -->
                    <div class="expanded-view">
                        <div class="expanded-header">
                            <h4>STANDARD EDITION <em>[Twenty Dollars]</em></h4>
                            <button class="close-info-btn">×</button>
                        </div>
                        <div class="expanded-info-container">
                            <ul class="edition-info-list">
                                <li>High-quality paperback
                                    <ul>
                                        <li>Premium paper stock</li>
                                        <li>Beautiful color reproduction</li>
                                    </ul>
                                </li>
                                <li>BEST DEAL, physical art!
                                    <ul>
                                        <li>Most affordable physical edition</li>
                                        <li>Same content as deluxe edition</li>
                                    </ul>
                                </li>
                                <li>Free DIY poster included
                                    <ul>
                                        <li>High-quality tearout poster</li>
                                        <li>Perfect for framing</li>
                                    </ul>
                                </li>
                            </ul>
                            <img src="https://via.placeholder.com/80x100" alt="Standard Edition" class="edition-image">
                        </div>
                        <a href="#events" class="btn action-btn reserve-physical-btn">Reserve Pickup</a>
                    </div>
                </article>

                <!-- Deluxe Edition -->
                <article class="edition-card deluxe">
                    <h3 class="edition-name">Deluxe<br>Edition</h3>
                    <p class="edition-price">$50</p>
                    
                    <!-- Normal View Buttons -->
                    <div class="normal-view">
                        <div class="edition-buttons">
                            <button class="btn info-btn">More Info</button>
                            <a href="#events" class="btn action-btn reserve-physical-btn">Reserve Pickup</a>
                        </div>
                    </div>
                    
                    <!-- Expanded View Content -->
                    <div class="expanded-view">
                        <div class="expanded-header">
                            <h4>DELUXE EDITION <em>[Fifty Dollars]</em></h4>
                            <button class="close-info-btn">×</button>
                        </div>
                        <div class="expanded-info-container">
                            <ul class="edition-info-list">
                                <li>Unique front/back cover, signed by bignosemichael [an unknown 25 year old]
                                    <ul>
                                        <li>Each cover is one-of-a-kind</li>
                                        <li>Hand-signed by the artist</li>
                                    </ul>
                                </li>
                                <li>Extra 16-page section [MAKING CHOICES while...DRUNK? and HIGH! aka TEXT]
                                    <ul>
                                        <li>Exclusive content not in other editions</li>
                                        <li>Behind-the-scenes creative process</li>
                                    </ul>
                                </li>
                                <li>Intentionally overpriced
                                    <ul>
                                        <li>Limited collector's edition</li>
                                        <li>Support the artist at a premium level</li>
                                    </ul>
                                </li>
                            </ul>
                            <img src="https://via.placeholder.com/80x100" alt="Deluxe Edition" class="edition-image">
                        </div>
                        <a href="#events" class="btn action-btn reserve-physical-btn">Reserve Pickup</a>
                    </div>
                </article>
            </div>
        </section>

        <hr class="pixel-divider">

        <!-- Info Tiles Section -->
        <section id="new-book-intro" class="new-intro-section">
            <div class="info-tiles-container">
                <div class="gif-tile">
                    <img src="https://github.com/456-Dev/456commercial/blob/main/image_lottery/selector.gif?raw=true" 
                         alt="Interactive GIF" 
                         id="interactive-gif"
                         data-animated-src="https://github.com/456-Dev/456commercial/blob/main/image_lottery/selector.gif?raw=true"
                         data-static-src="https://github.com/456-Dev/456commercial/blob/main/image_lottery/image_lottery.png?raw=true">
                    <p id="frame-message" class="frame-message"></p>
                    <p id="click-message" class="click-message"></p>
                </div>
                <div class="text-tile">
                    <h3 class="about-title">ABOUT THIS BOOK</h3>
                    <ul class="about-list">
                        <li>
                            <span class="bulletr">●</span>
                            <span class="item-content"><strong>160 full color pages]</strong> [8.5" by 11"] of <em>photograghy</em> broken into 7 <u>unique</u> sections</span>
                        </li>
                        <li>
                            <span class="bulletg">■</span>
                            <span class="item-content">456 <u>Traditional</u> street photograghs, <em>hyper-processed</em> images and creative writing from your favorite <strong>guest writers!</strong></span>
                        </li>
                        <li>
                            <span class="bulletb">▲</span>
                            <span class="item-content">This book may [or may not] contain: <strong>sexy humans</strong>, <em>dead rats</em> and <u>general non-sense</u>. 
                                                        <p>Enjoy at your own risk!</p></span>
                        </li>
                    </ul>
                </div>
            </div>
        </section>

        <hr class="pixel-divider">

        <!-- Events Section -->
        <section id="events" class="events-section">
            <h2>Upcoming NYC Pickup Events</h2>
            <p class="section-intro">Select an upcoming event below to book your pickup slot for Standard or Deluxe editions. Only 25 slots per event!</p>
            <div class="event-list">
                <article class="event-card" data-event-name="Union Square Park Pop-Up" data-event-slots-total="25" data-event-slots-booked="5">
                    <h3 class="event-name">Union Square Park Pop-Up</h3>
                    <p class="event-details">Sat, November 9th, 2024 | 11:00 AM - 3:00 PM</p>
                    <p class="event-location">Meet near the South Plaza fountain.</p>
                    <div class="slots-tracker">
                        Slots Remaining: <span class="slots-available">20</span>/25
                        <div class="slots-bar-container">
                            <div class="slots-bar-filled" style="width: 20%;"></div>
                        </div>
                    </div>
                    <button class="btn book-slot-btn">Book Pickup Slot</button>
                </article>
                <article class="event-card" data-event-name="Brooklyn Bridge Park Pop-Up" data-event-slots-total="25" data-event-slots-booked="10">
                    <h3 class="event-name">Brooklyn Bridge Park Pop-Up</h3>
                    <p class="event-details">Sun, November 17th, 2024 | 1:00 PM - 4:00 PM</p>
                    <p class="event-location">Pier 1, near the Granite Prospect.</p>
                    <div class="slots-tracker">
                        Slots Remaining: <span class="slots-available">15</span>/25
                        <div class="slots-bar-container">
                            <div class="slots-bar-filled" style="width: 40%;"></div>
                        </div>
                    </div>
                    <button class="btn book-slot-btn">Book Pickup Slot</button>
                </article>
            </div>
        </section>

        <hr class="pixel-divider">
         <section id="how-it-works" class="how-it-works-section">
            <h2>How Book Orders Work</h2>
            <ol class="steps-list">
                <li><span>1</span>Choose Standard or Deluxe Edition & click "Reserve for Pop-Up Pickup".</li>
                <li><span>2</span>You'll be scrolled to the "Upcoming Events" section.</li>
                <li><span>3</span>Select an event and click "Book Pickup Slot".</li>
                <li><span>4</span>Fill in your details (email is key!) in the popup form.</li>
                <li><span>5</span>Receive an email confirmation for your slot.</li>
                <li><span>6</span>Meet us at the event, pay (Cash/Venmo/etc.), and collect your reserved book!</li>
            </ol>
            
            <h3 
        </section>
    </div>

    <div class="banner-wrapper bottom-banner-wrapper">
        <div class="site-banner">
            <img src="https://github.com/456-Dev/456commercial/blob/main/footer.png?raw=true" alt="Book Cover Image: THEY SAID YOU CAN'T" class="banner-image">
        </div>
    </div>

    <footer class="site-footer-bottom">
        <p class="contact-info">Questions? Email: <a href="mailto:support@456solutions.com">support@456solutions.com</a></p>
        <p class="copyright">© <span id="currentYear"></span>  All Rights Reserved. 456solutions.com</p>
        </div>
    </footer>

    <!-- Booking Modal -->
    <div id="booking-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <button class="modal-close-btn" aria-label="Close modal">×</button>
            <h3 id="modal-event-name">Book Slot for [Event Name]</h3>
            <form id="booking-form">
                <input type="hidden" name="event_name" id="form-event-name-hidden" value="">
                <input type="hidden" name="_subject" value="Your THEY SAID YOU CAN'T Reservation Confirmation">
                <div class="form-group">
                    <label for="book-choice">Which book edition are you reserving?</label>
                    <select id="book-choice" name="book_edition_reserved" required>
                        <option value="Standard Edition - $20">Standard Edition - $20</option>
                        <option value="Deluxe [Worse] Edition - $50">Deluxe [Worse] Edition - $50</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="email">Your Email*</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone (Optional)</label>
                    <input type="tel" id="phone" name="phone">
                </div>
                <div class="form-group">
                    <label for="instagram">Instagram (Optional, include @)</label>
                    <input type="text" id="instagram" name="instagram">
                </div>
                <p class="form-note">Confirmation sent to email. Payment due at pickup.</p>
                <button type="submit" class="btn modal-submit-btn">Submit Reservation</button>
            </form>
        </div>
    </div>

    <!-- Digital Purchase Modal -->
    <div id="digital-purchase-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <button class="modal-close-btn" aria-label="Close modal">×</button>
            <h3>Purchase Digital Edition - $5</h3>
            <div class="digital-purchase-info">
                <p>Get immediate access to the full book as a high-quality PDF after payment.</p>
                <p>Please pay $5 using one of these methods:</p>
                <div class="payment-options">
                    <a href="https://venmo.com/michaellinares" target="_blank" class="payment-option venmo">Venmo</a>
                    <a href="https://cash.app/michaellinares" target="_blank" class="payment-option cashapp">Cash App</a>
                    <button class="payment-option zelle" id="zelle-digital-btn">Zelle</button>
                </div>
                
                <!-- Zelle Info Section -->
                <div id="zelle-digital-info" class="zelle-info" style="display: none;">
                    <div class="zelle-details">
                        <h5>Zelle Payment Details:</h5>
                        <p>Send $5 to: <strong>michaellinaresfilms@gmail.com</strong></p>
                        <p class="zelle-note">Use your banking app to make the Zelle payment, then return to this page and click the confirmation button below.</p>
                    </div>
                </div>
            </div>
            <div class="promo-area">
                <div class="form-group">
                    <label for="promo-code">Have a promo code?</label>
                    <input type="text" id="promo-code" placeholder="Enter promo code">
                    <button id="apply-promo-btn" class="btn">Apply</button>
                </div>
            </div>
            <div class="honor-system">
                <p>After paying, click the button below:</p>
                <button id="paid-confirmation-btn" class="btn modal-submit-btn">I Swear To God I Paid $5</button>
            </div>
            <div id="download-section" style="display: none;">
                <h4>Thank you for your support!</h4>
                <p>Click below to access your digital copy:</p>
                <a href="#" class="btn download-btn" target="_blank">Access Digital Book</a>
            </div>
        </div>
    </div>

    <!-- Delivery Order Modal -->
    <div id="delivery-modal" class="modal-overlay" aria-hidden="true">
        <div class="modal-content">
            <button class="modal-close-btn" aria-label="Close modal">×</button>
            <h3>Order Deluxe Edition - Delivery</h3>
            <p class="delivery-intro">Order the Deluxe [Worse] Edition for $58 ($50 + $8 shipping).</p>
            
            <form id="delivery-form" action="https://formsubmit.io/send/books@456solutions.com" method="POST">
                <input type="hidden" name="order_type" value="Deluxe Edition Delivery - $58">
                <input type="hidden" name="_subject" value="Your THEY SAID YOU CAN'T Deluxe Edition Order Confirmation">
                <input type="hidden" name="_redirect" value="false">
                <input type="hidden" name="_autoresponse" value="Thank you for your Deluxe Edition order. Your book will be shipped within 5-7 business days, and tracking information will be sent to your email.">
                
                <div class="form-group">
                    <label for="full-name">Full Name*</label>
                    <input type="text" id="full-name" name="full_name" required>
                </div>
                
                <div class="form-group">
                    <label for="delivery-email">Email Address*</label>
                    <input type="email" id="delivery-email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="delivery-phone">Phone Number*</label>
                    <input type="tel" id="delivery-phone" name="phone" required>
                </div>
                
                <div class="form-group">
                    <label for="delivery-address">Shipping Address*</label>
                    <textarea id="delivery-address" name="shipping_address" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="delivery-city">City*</label>
                    <input type="text" id="delivery-city" name="city" required>
                </div>
                
                <div class="form-group double-field">
                    <div>
                        <label for="delivery-state">State*</label>
                        <input type="text" id="delivery-state" name="state" required>
                    </div>
                    <div>
                        <label for="delivery-zip">ZIP Code*</label>
                        <input type="text" id="delivery-zip" name="zip_code" required>
                    </div>
                </div>
                
                <div class="payment-section">
                    <h4>Payment Options</h4>
                    <p>Please pay $58 using one of these methods:</p>
                    <div class="payment-options">
                        <a href="https://venmo.com/michaellinares" target="_blank" class="payment-option venmo">Venmo</a>
                        <a href="https://cash.app/michaellinares" target="_blank" class="payment-option cashapp">Cash App</a>
                        <button class="payment-option zelle" id="zelle-delivery-btn">Zelle</button>
                    </div>
                    
                    <!-- Zelle Info Section -->
                    <div id="zelle-delivery-info" class="zelle-info" style="display: none;">
                        <div class="zelle-details">
                            <h5>Zelle Payment Details:</h5>
                            <p>Send $58 to: <strong>michaellinaresfilms@gmail.com</strong></p>
                            <p class="zelle-note">Use your banking app to make the Zelle payment, then return to this page.</p>
                        </div>
                    </div>
                    <p class="payment-note">After completing payment, check the box below:</p>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="payment-confirmation" name="payment_confirmed" required>
                        <label for="payment-confirmation">I confirm I've sent $58 payment</label>
                    </div>
                </div>
                
                <p class="form-note">Books typically ship within 5-7 business days of order. Tracking information will be sent to your email.</p>
                <button type="submit" class="btn modal-submit-btn">Complete Order</button>
            </form>
            
            <div id="order-success" style="display: none;">
                <h4>Thank you for your order!</h4>
                <p>Your Deluxe Edition will be shipped soon. Check your email for confirmation.</p>
            </div>
        </div>
    </div>

    <!-- Add this overlay div at the bottom of the body -->
    <div class="modal-overlay"></div>

    <script src="script.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <!-- Firebase Config -->
    <script>
        // Your web app's Firebase configuration
        // Replace with your actual Firebase project config
        const firebaseConfig = {
            apiKey: "AIzaSyDnUlmVv1PBF_gXqeyM4aEaV6hndrXPeBw",
            authDomain: "books-bookings.firebaseapp.com",
            projectId: "books-bookings",
            storageBucket: "books-bookings.firebasestorage.app",
            messagingSenderId: "704734229089",
            appId: "1:704734229089:web:acd4877e3d11ad24503020"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Dispatch event when Firebase is ready
        window.db = db;
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Initialize EmailJS globally -->
    <script>
        // Initialize EmailJS globally
        console.log("Initializing EmailJS globally...");
        (function() {
            // Initialize with defer to ensure it's fully loaded
            emailjs.init("8c7vCsoyTAZuZfMap");
            console.log("EmailJS initialized successfully");
        })();
        
        // Global test function for EmailJS debugging
        window.testEmailJS = async function() {
            console.log("Testing EmailJS...");
            try {
                const serviceId = "service_hubj58x";
                const templateId = "template_da4g2be";
                
                const testData = {
                    subscriber_email: "michaellinaresfilms@gmail.com",
                    event_name: "Test Event",
                    book_edition: "Test Edition",
                    confirmation_link: "https://456solutions.com/confirm?id=test123",
                    // Use the corrected field name (single 'l')
                    to_email: "michaellinaresfilms@gmail.com",
                    to_name: "Test User",
                    email: "michaellinaresfilms@gmail.com",
                    from_name: "Book Order System",
                    reply_to: "michaellinaresfilms@gmail.com"
                };
                
                console.log(`Using service ID: "${serviceId}", template ID: "${templateId}", and data:`, testData);
                
                const testResult = await emailjs.send(
                    serviceId,
                    templateId,
                    testData,
                    "8c7vCsoyTAZuZfMap" // Pass the public key again for redundancy
                );
                console.log("EmailJS test successful:", testResult);
                return testResult;
            } catch (error) {
                console.error("EmailJS test failed:", error);
                throw error;
            }
        };
        
        // Add a global function to send emails that can be called from the module script
        window.sendConfirmationEmail = function(emailData) {
            console.log("Global sendConfirmationEmail called with data:", emailData);
            
            const serviceId = "service_hubj58x";
            const templateId = "template_da4g2be";
            
            return emailjs.send(
                serviceId,
                templateId,
                emailData,
                "8c7vCsoyTAZuZfMap"
            );
        };
    </script>

    <!-- Add EmailJS template inspector -->
    <script>
        // This function will help diagnose template parameter issues
        window.inspectEmailJSTemplate = async function() {
            console.log("Checking EmailJS template...");
            try {
                const serviceId = "service_hubj58x";
                const templateId = "template_da4g2be";
                
                // Log the service and template IDs
                console.log(`Using Service ID: ${serviceId}`);
                console.log(`Using Template ID: ${templateId}`);
                
                console.log("To fix the 'recipients address is empty' error:");
                console.log("1. Go to your EmailJS dashboard");
                console.log("2. Open the template 'template_da4g2be'");
                console.log("3. Check the '_to' field - this is where the recipient email must go");
                console.log("4. Verify which parameter name is used for the '_to' field");
                console.log("5. Use exactly that parameter name in your code");
                
                return "See console for template inspection instructions";
            } catch (error) {
                console.error("Error inspecting template:", error);
                return error;
            }
        };
    </script>

    <!-- Firebase Modular v9 SDK -->
    <script type="module">
        // Import Firebase modules
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        
        import { 
            getApp 
        } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';

        // Wait for Firebase to be ready
        window.addEventListener('firebase-ready', () => {
            // Get Firebase app and initialize Firestore
            const app = getApp();
            const db = getFirestore(app);
            const bookingsCollection = collection(db, "bookings");

            // Debug test - check if EmailJS is accessible within this module
            console.log("Checking if EmailJS is accessible in the module:", typeof emailjs);
            try {
                emailjs.send(
                    "service_hubj58x",
                    "template_da4g2be",
                    {
                        to_email: "michaellinaresfilms@gmail.com",
                        to_name: "Test User",
                        from_name: "Debug Test",
                        subscriber_email: "michaellinaresfilms@gmail.com",
                        event_name: "Debug Test",
                        book_edition: "Debug Test",
                        confirmation_link: "https://456solutions.com/debug"
                    },
                    "8c7vCsoyTAZuZfMap"
                ).then(response => {
                    console.log("Debug test email sent successfully:", response);
                }).catch(error => {
                    console.error("Debug test email failed:", error);
                });
            } catch (error) {
                console.error("Error accessing EmailJS in module:", error);
            }

            // Get booking form
            const bookingForm = document.getElementById('booking-form');

            // Handle form submission
            if (bookingForm) {
                bookingForm.addEventListener('submit', function(e) {
                    e.preventDefault(); // Prevent default form submission
                    console.log("Form submitted - starting processing");
                    
                    // Get form data
                    const email = document.getElementById('email').value;
                    const eventName = document.getElementById('form-event-name-hidden').value;
                    const bookEditionReserved = document.getElementById('book-choice').value;
                    
                    console.log("Form data collected:", { email, eventName, bookEditionReserved });
                    
                    // First save to Firestore
                    console.log("Adding document to Firestore...");
                    addDoc(bookingsCollection, {
                        email,
                        event_name: eventName,
                        book_edition_reserved: bookEditionReserved,
                        createdAt: serverTimestamp()
                    })
                    .then(docRef => {
                        console.log("Document added to Firestore with ID:", docRef.id);
                        
                        // Now send email with EmailJS
                        console.log("Preparing to send confirmation email...");
                        
                        // IMPORTANT: These IDs must match your EmailJS dashboard
                        const serviceId = "service_hubj58x";
                        const templateId = "template_da4g2be";
                        
                        // Prepare email data
                        const emailData = {
                            subscriber_email: email,
                            event_name: eventName,
                            book_edition: bookEditionReserved,
                            confirmation_link: "https://456solutions.com/confirm?id=" + docRef.id,
                            to_email: email,
                            to_name: email.split('@')[0], // Simple placeholder for name
                            email: email,
                            from_name: "THEY SAID YOU CAN'T - Book Reservation",
                            reply_to: "books@456solutions.com"
                        };
                        
                        console.log("Calling global sendConfirmationEmail function...");
                        
                        // Use the global function instead of calling EmailJS directly from module
                        return window.sendConfirmationEmail(emailData);
                    })
                    .then(emailResult => {
                        // Email sent successfully
                        console.log("Email sent successfully:", emailResult);
                        
                        // Show success message
                        alert("Reservation successful! A confirmation email has been sent to your address.");
                        
                        // Close modal
                        document.querySelector('.modal-close-btn').click();
                        
                        // Update UI (event slots, etc.)
                        updateEventUI(eventName);
                    })
                    .catch(error => {
                        // Handle any errors in the promise chain
                        if (error.status === 0) {
                            console.error("EmailJS error - likely network issue:", error);
                            alert("Your reservation was saved, but there was a network error sending the confirmation email. We'll send it manually. Your slot is confirmed!");
                        } else if (error.text && error.text.includes("recipient")) {
                            console.error("EmailJS recipient error:", error);
                            alert("Your reservation was saved, but there was an issue with the email address. We'll contact you manually. Your slot is confirmed!");
                        } else {
                            console.error("Error processing reservation:", error);
                            alert("There was an error processing your reservation. Please try again or contact support.");
                        }
                    });
                });
            }
            
            // Helper function to update event UI
            function updateEventUI(eventName) {
                const eventCard = document.querySelector(`.event-card[data-event-name="${eventName}"]`);
                if (eventCard) {
                    const totalSlots = parseInt(eventCard.dataset.eventSlotsTotal, 10);
                    const bookedSlots = parseInt(eventCard.dataset.eventSlotsBooked, 10);
                    
                    // Update booked slots
                    const newBookedSlots = bookedSlots + 1;
                    const newAvailableSlots = totalSlots - newBookedSlots;
                    
                    eventCard.dataset.eventSlotsBooked = newBookedSlots;
                    eventCard.querySelector('.slots-available').textContent = newAvailableSlots;
                    eventCard.querySelector('.slots-bar-filled').style.width = `${(newBookedSlots / totalSlots) * 100}%`;
                    
                    // Disable button if fully booked
                    if (newAvailableSlots <= 0) {
                        const bookButton = eventCard.querySelector('.book-slot-btn');
                        if (bookButton) {
                            bookButton.disabled = true;
                            bookButton.textContent = 'Fully Booked';
                            bookButton.style.backgroundColor = 'var(--pixel-grey)';
                        }
                    }
                }
            }
        });
    </script>
</body>
</html>